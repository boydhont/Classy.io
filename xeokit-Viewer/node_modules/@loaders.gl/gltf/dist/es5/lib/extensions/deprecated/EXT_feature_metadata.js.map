{"version":3,"file":"EXT_feature_metadata.js","names":["_gltfScenegraph","_interopRequireDefault","require","EXT_FEATURE_METADATA","name","exports","decode","_x","_decode","apply","arguments","_asyncToGenerator2","default","_regenerator","mark","_callee","gltfData","scenegraph","wrap","_callee$","_context","prev","next","GLTFScenegraph","decodeExtFeatureMetadata","stop","_extension$schema","extension","getExtension","schemaClasses","schema","classes","featureTables","featureTextures","console","warn","schemaName","schemaClass","featureTable","findFeatureTableByName","handleFeatureTableProperties","propertyName","properties","_featureTable$propert","schemaProperty","featureTableProperty","numberOfFeatures","count","data","getPropertyDataFromBinarySource","bufferView","getTypedArrayForBufferView","type","stringOffsetBufferView","offsetsData","getStringAttributes","schemaClassName","featureTableName","class","stringsCount","stringsArray","textDecoder","TextDecoder","stringOffset","bytesPerStringSize","index","stringByteSize","stringData","subarray","stringAttribute","push"],"sources":["../../../../../src/lib/extensions/deprecated/EXT_feature_metadata.ts"],"sourcesContent":["/* eslint-disable camelcase */\nimport type {GLTF} from '../../types/gltf-types';\n\nimport GLTFScenegraph from '../../api/gltf-scenegraph';\nimport {\n  ClassProperty,\n  EXT_feature_metadata_class_object,\n  EXT_feature_metadata_feature_table,\n  FeatureTableProperty,\n  GLTF_EXT_feature_metadata\n} from '../../types/gltf-json-schema';\n\n/** Extension name */\nconst EXT_FEATURE_METADATA = 'EXT_feature_metadata';\n\nexport const name = EXT_FEATURE_METADATA;\n\nexport async function decode(gltfData: {json: GLTF}): Promise<void> {\n  const scenegraph = new GLTFScenegraph(gltfData);\n  decodeExtFeatureMetadata(scenegraph);\n}\n\n/**\n * Decodes feature metadata from extension\n * @param scenegraph\n */\nfunction decodeExtFeatureMetadata(scenegraph: GLTFScenegraph): void {\n  const extension: GLTF_EXT_feature_metadata | null = scenegraph.getExtension(EXT_FEATURE_METADATA);\n  const schemaClasses = extension?.schema?.classes;\n  const featureTables = extension?.featureTables;\n  const featureTextures = extension?.featureTextures;\n\n  if (featureTextures) {\n    /*\n     * TODO add support for featureTextures\n     * Spec - https://github.com/CesiumGS/glTF/tree/3d-tiles-next/extensions/2.0/Vendor/EXT_feature_metadata#feature-textures\n     */\n    // eslint-disable-next-line no-console\n    console.warn('featureTextures is not yet supported in the \"EXT_feature_metadata\" extension.');\n  }\n\n  if (schemaClasses && featureTables) {\n    for (const schemaName in schemaClasses) {\n      const schemaClass = schemaClasses[schemaName];\n      const featureTable = findFeatureTableByName(featureTables, schemaName);\n\n      if (featureTable) {\n        handleFeatureTableProperties(scenegraph, featureTable, schemaClass);\n      }\n    }\n  }\n}\n\n/**\n * Navigate throw all properies in feature table and gets properties data.\n * @param scenegraph\n * @param featureTable\n * @param schemaClass\n */\nfunction handleFeatureTableProperties(\n  scenegraph: GLTFScenegraph,\n  featureTable: EXT_feature_metadata_feature_table,\n  schemaClass: EXT_feature_metadata_class_object\n): void {\n  for (const propertyName in schemaClass.properties) {\n    const schemaProperty = schemaClass.properties[propertyName];\n    const featureTableProperty = featureTable?.properties?.[propertyName];\n    const numberOfFeatures = featureTable.count;\n\n    if (featureTableProperty) {\n      const data = getPropertyDataFromBinarySource(\n        scenegraph,\n        schemaProperty,\n        numberOfFeatures,\n        featureTableProperty\n      );\n      featureTableProperty.data = data;\n    }\n  }\n}\n\n/**\n * Decode properties from binary sourse based on property type.\n * @param scenegraph\n * @param schemaProperty\n * @param numberOfFeatures\n * @param featureTableProperty\n */\nfunction getPropertyDataFromBinarySource(\n  scenegraph: GLTFScenegraph,\n  schemaProperty: ClassProperty,\n  numberOfFeatures: number,\n  featureTableProperty: FeatureTableProperty\n): Uint8Array | string[] {\n  const bufferView = featureTableProperty.bufferView;\n  // TODO think maybe we shouldn't get data only in Uint8Array format.\n  let data: Uint8Array | string[] = scenegraph.getTypedArrayForBufferView(bufferView);\n\n  switch (schemaProperty.type) {\n    case 'STRING': {\n      // stringOffsetBufferView should be available for string type.\n      const stringOffsetBufferView = featureTableProperty.stringOffsetBufferView!;\n      const offsetsData = scenegraph.getTypedArrayForBufferView(stringOffsetBufferView);\n      data = getStringAttributes(data, offsetsData, numberOfFeatures);\n      break;\n    }\n    default:\n  }\n\n  return data;\n}\n\n/**\n * Find the feature table by class name.\n * @param featureTables\n * @param schemaClassName\n */\nfunction findFeatureTableByName(\n  featureTables: {[key: string]: EXT_feature_metadata_feature_table},\n  schemaClassName: string\n): EXT_feature_metadata_feature_table | null {\n  for (const featureTableName in featureTables) {\n    const featureTable = featureTables[featureTableName];\n\n    if (featureTable.class === schemaClassName) {\n      return featureTable;\n    }\n  }\n\n  return null;\n}\n\n/**\n * Getting string attributes from binary data.\n * Spec - https://github.com/CesiumGS/3d-tiles/tree/main/specification/Metadata#strings\n * @param data\n * @param offsetsData\n * @param stringsCount\n */\nfunction getStringAttributes(\n  data: Uint8Array,\n  offsetsData: Uint8Array,\n  stringsCount: number\n): string[] {\n  const stringsArray: string[] = [];\n  const textDecoder = new TextDecoder('utf8');\n\n  let stringOffset = 0;\n  const bytesPerStringSize = 4;\n\n  for (let index = 0; index < stringsCount; index++) {\n    // TODO check if it is multiplication on bytesPerStringSize is valid operation?\n    const stringByteSize =\n      offsetsData[(index + 1) * bytesPerStringSize] - offsetsData[index * bytesPerStringSize];\n    const stringData = data.subarray(stringOffset, stringByteSize + stringOffset);\n    const stringAttribute = textDecoder.decode(stringData);\n\n    stringsArray.push(stringAttribute);\n    stringOffset += stringByteSize;\n  }\n\n  return stringsArray;\n}\n"],"mappings":"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"}