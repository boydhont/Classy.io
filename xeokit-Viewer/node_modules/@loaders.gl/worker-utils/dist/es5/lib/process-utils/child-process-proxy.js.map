{"version":3,"file":"child-process-proxy.js","names":["ChildProcess","_interopRequireWildcard","require","_processUtils","_getRequireWildcardCache","nodeInterop","WeakMap","cacheBabelInterop","cacheNodeInterop","obj","__esModule","_typeof","default","cache","has","get","newObj","hasPropertyDescriptor","Object","defineProperty","getOwnPropertyDescriptor","key","prototype","hasOwnProperty","call","desc","set","ownKeys","object","enumerableOnly","keys","getOwnPropertySymbols","symbols","filter","sym","enumerable","push","apply","_objectSpread","target","i","arguments","length","source","forEach","_defineProperty2","getOwnPropertyDescriptors","defineProperties","DEFAULT_PROPS","command","port","autoPort","wait","onSuccess","processProxy","console","log","concat","props","ChildProcessProxy","_ref","undefined","_ref$id","id","_classCallCheck2","_createClass2","value","_start","_asyncToGenerator2","_regenerator","mark","_callee","_this","args","wrap","_callee$","_context","prev","next","_toConsumableArray2","Number","portArg","getAvailablePort","sent","String","Promise","resolve","reject","_setTimeout","join","childProcess","spawn","stdout","on","data","toString","stderr","ignoreStderr","_clearTimeout","Error","error","code","abrupt","stop","start","_x","_stop","_callee2","_callee2$","_context2","kill","_exit","_callee3","statusCode","_args3","_callee3$","_context3","process","exit","t0","message","callback","successTimer","setTimeout","clearTimeout","exports"],"sources":["../../../../src/lib/process-utils/child-process-proxy.ts"],"sourcesContent":["/* eslint-disable no-console */\n// Avoid using named imports for Node builtins to help with \"empty\" resolution\n// for bundlers targeting browser environments. Access imports & types\n// through the `ChildProcess` object (e.g. `ChildProcess.spawn`, `ChildProcess.ChildProcess`).\nimport * as ChildProcess from 'child_process';\nimport {getAvailablePort} from './process-utils';\n\nexport type ChildProcessProxyProps = {\n  command: string;\n  arguments: string[];\n  /** Whether to add a port specified arg */\n  portArg?: string;\n  /** Base port number */\n  port?: number;\n  /** Whether to search for an available port if the base port is occupied */\n  autoPort?: boolean;\n  /** Number of milliseconds to wait until concluding success */\n  /** wait: 0 - infinity */\n  wait?: number;\n  /** Options passed on to Node'.js `spawn` */\n  spawn?: ChildProcess.SpawnOptionsWithoutStdio;\n  /** Should proceed if stderr stream recieved data */\n  ignoreStderr?: boolean;\n  /** Callback when the  */\n  onStart?: (proxy: ChildProcessProxy) => void;\n  onSuccess?: (proxy: ChildProcessProxy) => void;\n};\n\nconst DEFAULT_PROPS: ChildProcessProxyProps = {\n  command: '',\n  arguments: [],\n  port: 5000,\n  autoPort: true,\n  wait: 2000,\n  onSuccess: (processProxy) => {\n    console.log(`Started ${processProxy.props.command}`);\n  }\n};\n\n/**\n * Manager for a Node.js child process\n * Prepares arguments, starts, stops and tracks output\n */\nexport default class ChildProcessProxy {\n  id: string;\n  props: ChildProcessProxyProps = {...DEFAULT_PROPS};\n  private childProcess: ChildProcess.ChildProcess | null = null;\n  private port: number = 0;\n  private successTimer?: any; // NodeJS.Timeout;\n\n  // constructor(props?: {id?: string});\n  constructor({id = 'browser-driver'} = {}) {\n    this.id = id;\n  }\n\n  /** Starts a child process with the provided props */\n  async start(props: ChildProcessProxyProps): Promise<object> {\n    props = {...DEFAULT_PROPS, ...props};\n    this.props = props;\n\n    const args = [...props.arguments];\n\n    // If portArg is set, we can look up an available port\n    this.port = Number(props.port);\n    if (props.portArg) {\n      if (props.autoPort) {\n        this.port = await getAvailablePort(props.port);\n      }\n      args.push(props.portArg, String(this.port));\n    }\n\n    return await new Promise((resolve, reject) => {\n      try {\n        this._setTimeout(() => {\n          if (props.onSuccess) {\n            props.onSuccess(this);\n          }\n          resolve({});\n        });\n\n        console.log(`Spawning ${props.command} ${props.arguments.join(' ')}`);\n        const childProcess = ChildProcess.spawn(props.command, args, props.spawn);\n        this.childProcess = childProcess;\n\n        childProcess.stdout.on('data', (data) => {\n          console.log(data.toString());\n        });\n        childProcess.stderr.on('data', (data) => {\n          console.log(`Child process wrote to stderr: \"${data}\".`);\n          if (!props.ignoreStderr) {\n            this._clearTimeout();\n            reject(new Error(data));\n          }\n        });\n        childProcess.on('error', (error) => {\n          console.log(`Child process errored with ${error}`);\n          this._clearTimeout();\n          reject(error);\n        });\n        childProcess.on('close', (code) => {\n          console.log(`Child process exited with ${code}`);\n          this.childProcess = null;\n          this._clearTimeout();\n          resolve({});\n        });\n      } catch (error) {\n        reject(error);\n      }\n    });\n  }\n\n  /** Stops a running child process */\n  async stop(): Promise<void> {\n    if (this.childProcess) {\n      this.childProcess.kill();\n      this.childProcess = null;\n    }\n  }\n\n  /** Exits this process */\n  async exit(statusCode: number = 0): Promise<void> {\n    try {\n      await this.stop();\n      // eslint-disable-next-line no-process-exit\n      process.exit(statusCode);\n    } catch (error) {\n      console.error((error as Error).message || error);\n      // eslint-disable-next-line no-process-exit\n      process.exit(1);\n    }\n  }\n\n  _setTimeout(callback: (...args: any[]) => void) {\n    if (Number(this.props.wait) > 0) {\n      this.successTimer = setTimeout(callback, this.props.wait);\n    }\n  }\n\n  _clearTimeout() {\n    if (this.successTimer) {\n      clearTimeout(this.successTimer);\n    }\n  }\n}\n"],"mappings":"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"}