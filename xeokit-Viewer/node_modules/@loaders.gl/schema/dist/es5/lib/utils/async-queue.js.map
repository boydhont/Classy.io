{"version":3,"file":"async-queue.js","names":["ArrayQueue","_Array","_inherits2","default","_super","_createSuper","_classCallCheck2","apply","arguments","_createClass2","key","value","enqueue","push","dequeue","shift","_wrapNativeSuper2","Array","_Symbol$asyncIterator","Symbol","asyncIterator","AsyncQueue","_defineProperty2","_values","_settlers","_closed","close","length","resolve","done","Error","settler","reject","next","_this","Promise","exports","takeAsync","_x","_takeAsync","_asyncToGenerator2","_regenerator","mark","_callee","asyncIterable","count","result","iterator","_yield$iterator$next","_value2","_args","wrap","_callee$","_context","prev","undefined","Infinity","sent","abrupt","stop"],"sources":["../../../../src/lib/utils/async-queue.ts"],"sourcesContent":["// From https://github.com/rauschma/async-iter-demo/tree/master/src under MIT license\n// http://2ality.com/2016/10/asynchronous-iteration.html\n\nclass ArrayQueue<T> extends Array<T> {\n  enqueue(value: T) {\n    // Add at the end\n    return this.push(value);\n  }\n  dequeue(): T {\n    // Remove first element\n    return this.shift() as T;\n  }\n}\n\nexport default class AsyncQueue<T> {\n  private _values: ArrayQueue<T | Error>;\n  private _settlers: ArrayQueue<{resolve: (value: any) => void; reject: (reason?: any) => void}>;\n  private _closed: boolean;\n\n  constructor() {\n    // enqueues > dequeues\n    this._values = new ArrayQueue<T>();\n    // dequeues > enqueues\n    this._settlers = new ArrayQueue<{\n      resolve: (value: any) => void;\n      reject: (reason?: any) => void;\n    }>();\n    this._closed = false;\n  }\n\n  close(): void {\n    while (this._settlers.length > 0) {\n      this._settlers.dequeue().resolve({done: true});\n    }\n    this._closed = true;\n  }\n\n  [Symbol.asyncIterator](): AsyncIterator<T> {\n    return this;\n  }\n\n  enqueue(value: T | Error): void {\n    if (this._closed) {\n      throw new Error('Closed');\n    }\n\n    if (this._settlers.length > 0) {\n      if (this._values.length > 0) {\n        throw new Error('Illegal internal state');\n      }\n      const settler = this._settlers.dequeue();\n      if (value instanceof Error) {\n        settler.reject(value);\n      } else {\n        settler.resolve({value});\n      }\n    } else {\n      this._values.enqueue(value);\n    }\n  }\n\n  /**\n   * @returns a Promise for an IteratorResult\n   */\n  next(): Promise<any> {\n    if (this._values.length > 0) {\n      const value = this._values.dequeue();\n      if (value instanceof Error) {\n        return Promise.reject(value);\n      }\n      return Promise.resolve({value});\n    }\n\n    if (this._closed) {\n      if (this._settlers.length > 0) {\n        throw new Error('Illegal internal state');\n      }\n      return Promise.resolve({done: true});\n    }\n    // Wait for new values to be enqueued\n    return new Promise((resolve, reject) => {\n      this._settlers.enqueue({resolve, reject});\n    });\n  }\n}\n\n/**\n * @returns a Promise for an Array with the elements in `asyncIterable`\n */\nexport async function takeAsync(\n  asyncIterable: AsyncIterable<any>,\n  count = Infinity\n): Promise<any[]> {\n  const result: Array<any> = [];\n  const iterator = asyncIterable[Symbol.asyncIterator]();\n  while (result.length < count) {\n    const {value, done} = await iterator.next();\n    if (done) {\n      break;\n    }\n    result.push(value);\n  }\n  return result;\n}\n"],"mappings":";;;;;;;;;;;;;;;;;;;;IAGMA,UAAU,aAAAC,MAAA;EAAA,IAAAC,UAAA,CAAAC,OAAA,EAAAH,UAAA,EAAAC,MAAA;EAAA,IAAAG,MAAA,GAAAC,YAAA,CAAAL,UAAA;EAAA,SAAAA,WAAA;IAAA,IAAAM,gBAAA,CAAAH,OAAA,QAAAH,UAAA;IAAA,OAAAI,MAAA,CAAAG,KAAA,OAAAC,SAAA;EAAA;EAAA,IAAAC,aAAA,CAAAN,OAAA,EAAAH,UAAA;IAAAU,GAAA;IAAAC,KAAA,EACd,SAAAC,QAAQD,KAAQ,EAAE;MAEhB,OAAO,IAAI,CAACE,IAAI,CAACF,KAAK,CAAC;IACzB;EAAC;IAAAD,GAAA;IAAAC,KAAA,EACD,SAAAG,QAAA,EAAa;MAEX,OAAO,IAAI,CAACC,KAAK,CAAC,CAAC;IACrB;EAAC;EAAA,OAAAf,UAAA;AAAA,MAAAgB,iBAAA,CAAAb,OAAA,EARyBc,KAAK;AAAAC,qBAAA,GAkC9BC,MAAM,CAACC,aAAa;AAAA,IAvBFC,UAAU;EAK7B,SAAAA,WAAA,EAAc;IAAA,IAAAf,gBAAA,CAAAH,OAAA,QAAAkB,UAAA;IAAA,IAAAC,gBAAA,CAAAnB,OAAA;IAAA,IAAAmB,gBAAA,CAAAnB,OAAA;IAAA,IAAAmB,gBAAA,CAAAnB,OAAA;IAEZ,IAAI,CAACoB,OAAO,GAAG,IAAIvB,UAAU,CAAI,CAAC;IAElC,IAAI,CAACwB,SAAS,GAAG,IAAIxB,UAAU,CAG5B,CAAC;IACJ,IAAI,CAACyB,OAAO,GAAG,KAAK;EACtB;EAAC,IAAAhB,aAAA,CAAAN,OAAA,EAAAkB,UAAA;IAAAX,GAAA;IAAAC,KAAA,EAED,SAAAe,MAAA,EAAc;MACZ,OAAO,IAAI,CAACF,SAAS,CAACG,MAAM,GAAG,CAAC,EAAE;QAChC,IAAI,CAACH,SAAS,CAACV,OAAO,CAAC,CAAC,CAACc,OAAO,CAAC;UAACC,IAAI,EAAE;QAAI,CAAC,CAAC;MAChD;MACA,IAAI,CAACJ,OAAO,GAAG,IAAI;IACrB;EAAC;IAAAf,GAAA,EAAAQ,qBAAA;IAAAP,KAAA,EAED,SAAAA,MAAA,EAA2C;MACzC,OAAO,IAAI;IACb;EAAC;IAAAD,GAAA;IAAAC,KAAA,EAED,SAAAC,QAAQD,KAAgB,EAAQ;MAC9B,IAAI,IAAI,CAACc,OAAO,EAAE;QAChB,MAAM,IAAIK,KAAK,CAAC,QAAQ,CAAC;MAC3B;MAEA,IAAI,IAAI,CAACN,SAAS,CAACG,MAAM,GAAG,CAAC,EAAE;QAC7B,IAAI,IAAI,CAACJ,OAAO,CAACI,MAAM,GAAG,CAAC,EAAE;UAC3B,MAAM,IAAIG,KAAK,CAAC,wBAAwB,CAAC;QAC3C;QACA,IAAMC,OAAO,GAAG,IAAI,CAACP,SAAS,CAACV,OAAO,CAAC,CAAC;QACxC,IAAIH,KAAK,YAAYmB,KAAK,EAAE;UAC1BC,OAAO,CAACC,MAAM,CAACrB,KAAK,CAAC;QACvB,CAAC,MAAM;UACLoB,OAAO,CAACH,OAAO,CAAC;YAACjB,KAAK,EAALA;UAAK,CAAC,CAAC;QAC1B;MACF,CAAC,MAAM;QACL,IAAI,CAACY,OAAO,CAACX,OAAO,CAACD,KAAK,CAAC;MAC7B;IACF;EAAC;IAAAD,GAAA;IAAAC,KAAA,EAKD,SAAAsB,KAAA,EAAqB;MAAA,IAAAC,KAAA;MACnB,IAAI,IAAI,CAACX,OAAO,CAACI,MAAM,GAAG,CAAC,EAAE;QAC3B,IAAMhB,MAAK,GAAG,IAAI,CAACY,OAAO,CAACT,OAAO,CAAC,CAAC;QACpC,IAAIH,MAAK,YAAYmB,KAAK,EAAE;UAC1B,OAAOK,OAAO,CAACH,MAAM,CAACrB,MAAK,CAAC;QAC9B;QACA,OAAOwB,OAAO,CAACP,OAAO,CAAC;UAACjB,KAAK,EAALA;QAAK,CAAC,CAAC;MACjC;MAEA,IAAI,IAAI,CAACc,OAAO,EAAE;QAChB,IAAI,IAAI,CAACD,SAAS,CAACG,MAAM,GAAG,CAAC,EAAE;UAC7B,MAAM,IAAIG,KAAK,CAAC,wBAAwB,CAAC;QAC3C;QACA,OAAOK,OAAO,CAACP,OAAO,CAAC;UAACC,IAAI,EAAE;QAAI,CAAC,CAAC;MACtC;MAEA,OAAO,IAAIM,OAAO,CAAC,UAACP,OAAO,EAAEI,MAAM,EAAK;QACtCE,KAAI,CAACV,SAAS,CAACZ,OAAO,CAAC;UAACgB,OAAO,EAAPA,OAAO;UAAEI,MAAM,EAANA;QAAM,CAAC,CAAC;MAC3C,CAAC,CAAC;IACJ;EAAC;EAAA,OAAAX,UAAA;AAAA;AAAAe,OAAA,CAAAjC,OAAA,GAAAkB,UAAA;AAAA,SAMmBgB,SAASA,CAAAC,EAAA;EAAA,OAAAC,UAAA,CAAAhC,KAAA,OAAAC,SAAA;AAAA;AAAA,SAAA+B,WAAA;EAAAA,UAAA,OAAAC,kBAAA,CAAArC,OAAA,EAAAsC,YAAA,CAAAtC,OAAA,CAAAuC,IAAA,CAAxB,SAAAC,QACLC,aAAiC;IAAA,IAAAC,KAAA;MAAAC,MAAA;MAAAC,QAAA;MAAAC,oBAAA;MAAAC,OAAA;MAAApB,IAAA;MAAAqB,KAAA,GAAA1C,SAAA;IAAA,OAAAiC,YAAA,CAAAtC,OAAA,CAAAgD,IAAA,UAAAC,SAAAC,QAAA;MAAA,kBAAAA,QAAA,CAAAC,IAAA,GAAAD,QAAA,CAAApB,IAAA;QAAA;UACjCY,KAAK,GAAAK,KAAA,CAAAvB,MAAA,QAAAuB,KAAA,QAAAK,SAAA,GAAAL,KAAA,MAAGM,QAAQ;UAEVV,MAAkB,GAAG,EAAE;UACvBC,QAAQ,GAAGH,aAAa,CAACzB,MAAM,CAACC,aAAa,CAAC,CAAC,CAAC;QAAA;UAAA,MAC/C0B,MAAM,CAACnB,MAAM,GAAGkB,KAAK;YAAAQ,QAAA,CAAApB,IAAA;YAAA;UAAA;UAAAoB,QAAA,CAAApB,IAAA;UAAA,OACEc,QAAQ,CAACd,IAAI,CAAC,CAAC;QAAA;UAAAe,oBAAA,GAAAK,QAAA,CAAAI,IAAA;UAApC9C,OAAK,GAAAqC,oBAAA,CAALrC,KAAK;UAAEkB,IAAI,GAAAmB,oBAAA,CAAJnB,IAAI;UAAA,KACdA,IAAI;YAAAwB,QAAA,CAAApB,IAAA;YAAA;UAAA;UAAA,OAAAoB,QAAA,CAAAK,MAAA;QAAA;UAGRZ,MAAM,CAACjC,IAAI,CAACF,OAAK,CAAC;UAAC0C,QAAA,CAAApB,IAAA;UAAA;QAAA;UAAA,OAAAoB,QAAA,CAAAK,MAAA,WAEdZ,MAAM;QAAA;QAAA;UAAA,OAAAO,QAAA,CAAAM,IAAA;MAAA;IAAA,GAAAhB,OAAA;EAAA,CACd;EAAA,OAAAJ,UAAA,CAAAhC,KAAA,OAAAC,SAAA;AAAA"}