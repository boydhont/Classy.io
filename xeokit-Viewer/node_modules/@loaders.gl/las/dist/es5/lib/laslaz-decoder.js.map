{"version":3,"file":"laslaz-decoder.js","names":["_lazPerf","_interopRequireDefault","require","Module","POINT_FORMAT_READERS","_","dv","position","getInt32","intensity","getUint16","classification","getUint8","color","readAs","buf","Type","arguments","length","undefined","offset","count","sub","slice","BYTES_PER_ELEMENT","r","ret","i","push","parseLASHeader","arraybuffer","start","o","pointsOffset","Uint32Array","pointsFormatId","Uint8Array","pointsStructSize","Uint16Array","pointsCount","scale","Float64Array","bounds","maxs","mins","LASLoader","_classCallCheck2","default","_defineProperty2","totalToRead","totalRead","versionAsString","isCompressed","_createClass2","key","value","open","getHeader","header","readData","skip","Error","readOffset","Math","min","end","buffer","hasMoreData","pointsToRead","bufferSize","ceil","pointsRead","src","set","close","LAZLoader","getModule","instance","LASZip","abInt","_malloc","byteLength","HEAPU8","error","concat","message","thisBuf","bufRead","getPoint","a","delete","LASDecoder","len","arrayb","decoder","pointSize","index","DataView","LASFile","determineVersion","determineFormat","formatId","loader","bit7","bit6","ver","Int8Array","version","isOpen","getUnpacker","exports","LASModuleWasLoaded"],"sources":["../../../src/lib/laslaz-decoder.ts"],"sourcesContent":["/*\n  Modified from Uday Verma and Howard Butler's plasio\n  https://github.com/verma/plasio/\n  MIT License\n*/\n// laslaz.js - treat as compiled code\nimport type {LASHeader} from './las-types';\nimport getModule from './libs/laz-perf';\n\nlet Module: any = null;\n\ntype LASReader = (dv: DataView) => {\n  [LASAttribute: string]: number | number[];\n};\n\ntype LASReaders = {\n  [key: number]: LASReader;\n};\n\ntype LASData = {\n  buffer: ArrayBuffer;\n  count: number;\n  hasMoreData: boolean;\n};\n\nconst POINT_FORMAT_READERS: LASReaders = {\n  0: (dv) => {\n    return {\n      position: [dv.getInt32(0, true), dv.getInt32(4, true), dv.getInt32(8, true)],\n      intensity: dv.getUint16(12, true),\n      classification: dv.getUint8(15)\n    };\n  },\n  1: (dv) => {\n    return {\n      position: [dv.getInt32(0, true), dv.getInt32(4, true), dv.getInt32(8, true)],\n      intensity: dv.getUint16(12, true),\n      classification: dv.getUint8(15)\n    };\n  },\n  2: (dv) => {\n    return {\n      position: [dv.getInt32(0, true), dv.getInt32(4, true), dv.getInt32(8, true)],\n      intensity: dv.getUint16(12, true),\n      classification: dv.getUint8(15),\n      color: [dv.getUint16(20, true), dv.getUint16(22, true), dv.getUint16(24, true)]\n    };\n  },\n  3: (dv) => {\n    return {\n      position: [dv.getInt32(0, true), dv.getInt32(4, true), dv.getInt32(8, true)],\n      intensity: dv.getUint16(12, true),\n      classification: dv.getUint8(15),\n      color: [dv.getUint16(28, true), dv.getUint16(30, true), dv.getUint16(32, true)]\n    };\n  }\n};\n\n/**\n * Reads incoming binary data depends on the Type parameter\n * @param buf\n * @param Type\n * @param offset\n * @param count\n * @returns number | number[] from incoming binary data\n */\nfunction readAs(buf: ArrayBuffer, Type: any = {}, offset: number, count?: number) {\n  count = count === undefined || count === 0 ? 1 : count;\n  const sub = buf.slice(offset, offset + Type.BYTES_PER_ELEMENT * count);\n\n  const r = new Type(sub);\n  if (count === 1) {\n    return r[0];\n  }\n\n  const ret: number[] = [];\n  for (let i = 0; i < count; i++) {\n    ret.push(r[i]);\n  }\n\n  return ret;\n}\n\n/**\n * Parsing of header's attributes\n * @param arraybuffer\n * @returns header as LASHeader\n */\nfunction parseLASHeader(arraybuffer: ArrayBuffer): LASHeader {\n  let start = 32 * 3 + 35;\n\n  const o: Partial<LASHeader> = {\n    pointsOffset: readAs(arraybuffer, Uint32Array, 32 * 3),\n    pointsFormatId: readAs(arraybuffer, Uint8Array, 32 * 3 + 8),\n    pointsStructSize: readAs(arraybuffer, Uint16Array, 32 * 3 + 8 + 1),\n    pointsCount: readAs(arraybuffer, Uint32Array, 32 * 3 + 11),\n    scale: readAs(arraybuffer, Float64Array, start, 3)\n  };\n  start += 24; // 8*3\n  o.offset = readAs(arraybuffer, Float64Array, start, 3);\n  start += 24;\n\n  const bounds = readAs(arraybuffer, Float64Array, start, 6);\n  start += 48; // 8*6;\n  o.maxs = [bounds[0], bounds[2], bounds[4]];\n  o.mins = [bounds[1], bounds[3], bounds[5]];\n\n  return o as LASHeader;\n}\n\n// LAS Loader\n// Loads uncompressed files\n//\nclass LASLoader {\n  arraybuffer: ArrayBuffer;\n  readOffset: number = 0;\n  header: LASHeader = {\n    pointsOffset: 0,\n    pointsFormatId: 0,\n    pointsStructSize: 0,\n    pointsCount: 0,\n    scale: [0, 0, 0],\n    offset: [0, 0, 0],\n    maxs: [0],\n    mins: [0],\n    totalToRead: 0,\n    totalRead: 0,\n    versionAsString: '',\n    isCompressed: true\n  };\n\n  constructor(arraybuffer: ArrayBuffer) {\n    this.arraybuffer = arraybuffer;\n  }\n\n  /**\n   * @returns boolean\n   */\n  open() {\n    // Nothing needs to be done to open this\n    return true;\n  }\n  /**\n   * Parsing of incoming binary\n   * @returns LASHeader\n   */\n  getHeader() {\n    this.header = parseLASHeader(this.arraybuffer);\n    return this.header;\n  }\n\n  /**\n   * Reading data\n   * @param count\n   * @param skip\n   * @returns new ArrayBuffer, count, hasMoreData\n   */\n  readData(count: number, skip: number) {\n    const {header, arraybuffer} = this;\n    if (!header) {\n      throw new Error('Cannot start reading data till a header request is issued');\n    }\n\n    let {readOffset} = this;\n    let start: number;\n\n    if (skip <= 1) {\n      count = Math.min(count, header.pointsCount - readOffset);\n      start = header.pointsOffset + readOffset * header.pointsStructSize;\n      const end = start + count * header.pointsStructSize;\n      readOffset += count;\n      this.readOffset = readOffset;\n      return {\n        buffer: arraybuffer.slice(start, end),\n        count,\n        hasMoreData: readOffset < header.pointsCount\n      };\n    }\n\n    const pointsToRead = Math.min(count * skip, header.pointsCount - readOffset);\n    const bufferSize = Math.ceil(pointsToRead / skip);\n    let pointsRead = 0;\n\n    const buf = new Uint8Array(bufferSize * header.pointsStructSize);\n    for (let i = 0; i < pointsToRead; i++) {\n      if (i % skip === 0) {\n        start = header.pointsOffset + readOffset * header.pointsStructSize;\n        const src = new Uint8Array(arraybuffer, start, header.pointsStructSize);\n\n        buf.set(src, pointsRead * header.pointsStructSize);\n        pointsRead++;\n      }\n\n      readOffset++;\n    }\n    this.readOffset = readOffset;\n\n    return {\n      buffer: buf.buffer,\n      count: pointsRead,\n      hasMoreData: readOffset < header.pointsCount\n    };\n  }\n  /**\n   * Method which brings data to null to close the file\n   * @returns\n   */\n  close() {\n    // @ts-ignore Possibly null\n    this.arraybuffer = null;\n    return true;\n  }\n}\n\n/**\n * LAZ Loader\n * Uses NaCL module to load LAZ files\n */\nclass LAZLoader {\n  arraybuffer: ArrayBuffer;\n  instance: any = null; // LASZip instance\n  header: LASHeader | null = null;\n\n  constructor(arraybuffer: ArrayBuffer) {\n    this.arraybuffer = arraybuffer;\n\n    if (!Module) {\n      // Avoid executing laz-perf on import\n      Module = getModule();\n    }\n  }\n\n  /**\n   * Opens the file\n   * @returns boolean\n   */\n  open(): boolean {\n    try {\n      const {arraybuffer} = this;\n      this.instance = new Module.LASZip();\n      const abInt = new Uint8Array(arraybuffer);\n      const buf = Module._malloc(arraybuffer.byteLength);\n\n      this.instance.arraybuffer = arraybuffer;\n      this.instance.buf = buf;\n      Module.HEAPU8.set(abInt, buf);\n      this.instance.open(buf, arraybuffer.byteLength);\n\n      this.instance.readOffset = 0;\n\n      return true;\n    } catch (error) {\n      throw new Error(`Failed to open file: ${(error as Error).message}`);\n    }\n  }\n\n  getHeader(): LASHeader {\n    if (!this.instance) {\n      throw new Error('You need to open the file before trying to read header');\n    }\n\n    try {\n      const header = parseLASHeader(this.instance.arraybuffer);\n      header.pointsFormatId &= 0x3f;\n      this.header = header;\n      return header;\n    } catch (error) {\n      throw new Error(`Failed to get header: ${(error as Error).message}`);\n    }\n  }\n  /**\n   * @param count\n   * @param offset\n   * @param skip\n   * @returns Data\n   */\n  readData(count: number, offset: number, skip: number): LASData {\n    if (!this.instance) {\n      throw new Error('You need to open the file before trying to read stuff');\n    }\n\n    const {header, instance} = this;\n\n    if (!header) {\n      throw new Error(\n        'You need to query header before reading, I maintain state that way, sorry :('\n      );\n    }\n\n    try {\n      const pointsToRead = Math.min(count * skip, header.pointsCount - instance.readOffset);\n      const bufferSize = Math.ceil(pointsToRead / skip);\n      let pointsRead = 0;\n\n      const thisBuf = new Uint8Array(bufferSize * header.pointsStructSize);\n      const bufRead = Module._malloc(header.pointsStructSize);\n      for (let i = 0; i < pointsToRead; i++) {\n        instance.getPoint(bufRead);\n\n        if (i % skip === 0) {\n          const a = new Uint8Array(Module.HEAPU8.buffer, bufRead, header.pointsStructSize);\n          thisBuf.set(a, pointsRead * header.pointsStructSize);\n          pointsRead++;\n        }\n\n        instance.readOffset++;\n      }\n\n      return {\n        buffer: thisBuf.buffer,\n        count: pointsRead,\n        hasMoreData: instance.readOffset < header.pointsCount\n      };\n    } catch (error) {\n      throw new Error(`Failed to read data: ${(error as Error).message}`);\n    }\n  }\n\n  /**\n   * Deletes the instance\n   * @returns boolean\n   */\n  close(): boolean {\n    try {\n      if (this.instance !== null) {\n        this.instance.delete();\n        this.instance = null;\n      }\n      return true;\n    } catch (error) {\n      throw new Error(`Failed to close file: ${(error as Error).message}`);\n    }\n  }\n}\n\n/**\n * Helper class: Decodes LAS records into points\n */\nclass LASDecoder {\n  arrayb: ArrayBuffer;\n  decoder: (dv: DataView) => {};\n  pointsCount: number;\n  pointSize: number;\n  scale: [number, number, number];\n  offset?: [number, number, number];\n  mins?: number[];\n  maxs?: number[];\n\n  constructor(buffer: ArrayBuffer, len: number, header: LASHeader) {\n    this.arrayb = buffer;\n    this.decoder = POINT_FORMAT_READERS[header.pointsFormatId];\n    this.pointsCount = len;\n    this.pointSize = header.pointsStructSize;\n    this.scale = header.scale;\n    this.offset = header.offset;\n    this.mins = header.mins;\n    this.maxs = header.maxs;\n  }\n\n  /**\n   * Decodes data depends on this point size\n   * @param index\n   * @returns New object\n   */\n  getPoint(index: number): {} {\n    if (index < 0 || index >= this.pointsCount) {\n      throw new Error('Point index out of range');\n    }\n\n    const dv = new DataView(this.arrayb, index * this.pointSize, this.pointSize);\n    return this.decoder(dv);\n  }\n}\n\n/**\n * A single consistent interface for loading LAS/LAZ files\n */\nexport class LASFile {\n  arraybuffer: ArrayBuffer;\n  formatId: number = 0;\n  loader: LASLoader | LAZLoader;\n  isCompressed: boolean = true;\n  isOpen: boolean = false;\n  version: number = 0;\n  versionAsString: string = '';\n\n  constructor(arraybuffer: ArrayBuffer) {\n    this.arraybuffer = arraybuffer;\n\n    if (this.determineVersion() > 13) {\n      throw new Error('Only file versions <= 1.3 are supported at this time');\n    }\n\n    this.determineFormat();\n    if (POINT_FORMAT_READERS[this.formatId] === undefined) {\n      throw new Error('The point format ID is not supported');\n    }\n\n    this.loader = this.isCompressed\n      ? new LAZLoader(this.arraybuffer)\n      : new LASLoader(this.arraybuffer);\n  }\n\n  /**\n   * Determines format in parameters of LASHeaer\n   */\n  determineFormat(): void {\n    const formatId = readAs(this.arraybuffer, Uint8Array, 32 * 3 + 8);\n    const bit7 = (formatId & 0x80) >> 7;\n    const bit6 = (formatId & 0x40) >> 6;\n\n    if (bit7 === 1 && bit6 === 1) {\n      throw new Error('Old style compression not supported');\n    }\n\n    this.formatId = formatId & 0x3f;\n    this.isCompressed = bit7 === 1 || bit6 === 1;\n  }\n\n  /**\n   * Determines version\n   * @returns version\n   */\n  determineVersion(): number {\n    const ver = new Int8Array(this.arraybuffer, 24, 2);\n    this.version = ver[0] * 10 + ver[1];\n    this.versionAsString = `${ver[0]}.${ver[1]}`;\n    return this.version;\n  }\n\n  /**\n   * Reads if the file is open\n   * @returns boolean\n   */\n  open(): void {\n    if (this.loader.open()) {\n      this.isOpen = true;\n    }\n  }\n  /**\n   * Gets the header\n   * @returns Header\n   */\n  getHeader(): LASHeader {\n    return this.loader.getHeader();\n  }\n\n  /**\n   * @param count\n   * @param start\n   * @param skip\n   * @returns Data\n   */\n  readData(count: number, start: number, skip: number): LASData {\n    return this.loader.readData(count, start, skip);\n  }\n\n  /**\n   * Closes the file\n   */\n  close(): void {\n    if (this.loader.close()) {\n      this.isOpen = false;\n    }\n  }\n  /**\n   */\n  getUnpacker(): typeof LASDecoder {\n    return LASDecoder;\n  }\n}\n\nexport const LASModuleWasLoaded = false;\n\n/* eslint no-use-before-define: 2 */\n"],"mappings":"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"}