{"version":3,"file":"image-format.js","names":["_loaderUtils","require","_createForOfIteratorHelper","o","allowArrayLike","it","Symbol","iterator","Array","isArray","_unsupportedIterableToArray","length","i","F","s","n","done","value","e","_e","f","TypeError","normalCompletion","didErr","err","call","step","next","_e2","return","minLen","_arrayLikeToArray","Object","prototype","toString","slice","constructor","name","from","test","arr","len","arr2","MIME_TYPES","mimeTypeSupportedPromise","getSupportedImageFormats","_getSupportedImageFormats","apply","arguments","_asyncToGenerator2","default","_regenerator","mark","_callee","supportedMimeTypes","_iterator","_step","_mimeType","supported","wrap","_callee$","_context","prev","abrupt","sent","Set","mimeType","isBrowser","checkBrowserImageFormatSupportAsync","t0","checkNodeImageFormatSupport","add","t1","finish","stop","mimeTypeSupportedSync","isImageFormatSupported","undefined","checkBrowserImageFormatSupport","NODE_FORMAT_SUPPORT","_parseImageNode","globalThis","_globalThis$_imageFor","_imageFormatsNode","Boolean","includes","testBrowserImageFormatSupport","TEST_IMAGE","_x","_checkBrowserImageFormatSupportAsync","_callee2","dataURL","_callee2$","_context2","testBrowserImageFormatSupportAsync","element","document","createElement","toDataURL","indexOf","concat","_unused","_x2","_testBrowserImageFormatSupportAsync","_callee3","testImageDataURL","_callee3$","_context3","Promise","resolve","image","Image","src","onload","height","onerror"],"sources":["../../../../src/lib/category-api/image-format.ts"],"sourcesContent":["// loaders.gl, MIT license\n\nimport {isBrowser} from '@loaders.gl/loader-utils';\n\nconst MIME_TYPES = [\n  'image/png',\n  'image/jpeg',\n  'image/gif',\n  'image/webp',\n  'image/avif',\n  'image/tiff',\n  // TODO - what is the correct type for SVG\n  'image/svg',\n  'image/svg+xml',\n  'image/bmp',\n  'image/vnd.microsoft.icon'\n];\n\n/** Only one round of tests is performed */\nconst mimeTypeSupportedPromise: Promise<Set<string>> | null = null;\n\n/** Run-time browser detection of file formats requires async tests for most precise results */\nexport async function getSupportedImageFormats(): Promise<Set<string>> {\n  if (mimeTypeSupportedPromise) {\n    return await mimeTypeSupportedPromise;\n  }\n\n  const supportedMimeTypes = new Set<string>();\n  for (const mimeType of MIME_TYPES) {\n    const supported = isBrowser\n      ? await checkBrowserImageFormatSupportAsync(mimeType)\n      : checkNodeImageFormatSupport(mimeType);\n    if (supported) {\n      supportedMimeTypes.add(mimeType);\n    }\n  }\n\n  return supportedMimeTypes;\n}\n\n/** Cache sync values for speed */\nconst mimeTypeSupportedSync: {[mimeType: string]: boolean} = {};\n\n/**\n * Check if image MIME type is supported. Result is cached to avoid repeated tests.\n */\nexport function isImageFormatSupported(mimeType: string): boolean {\n  if (mimeTypeSupportedSync[mimeType] === undefined) {\n    const supported = isBrowser\n      ? checkBrowserImageFormatSupport(mimeType)\n      : checkNodeImageFormatSupport(mimeType);\n    mimeTypeSupportedSync[mimeType] = supported;\n  }\n  return mimeTypeSupportedSync[mimeType];\n}\n\n/**\n * Checks that polyfills are installed and that mimeType is supported by polyfills\n * @todo Ideally polyfills should declare what formats they support, instead of storing that data here.\n */\nfunction checkNodeImageFormatSupport(mimeType: string): boolean {\n  /** @deprecated Remove these in 4.0 and rely on polyfills to inject them */\n  const NODE_FORMAT_SUPPORT = ['image/png', 'image/jpeg', 'image/gif'];\n  // @ts-ignore\n  const {_parseImageNode, _imageFormatsNode = NODE_FORMAT_SUPPORT} = globalThis;\n  return Boolean(_parseImageNode) && _imageFormatsNode.includes(mimeType);\n}\n\n/** Checks image format support synchronously.\n * @note Unreliable, fails on AVIF\n */\nfunction checkBrowserImageFormatSupport(mimeType: string): boolean {\n  switch (mimeType) {\n    case 'image/avif': // Will fail\n    case 'image/webp':\n      return testBrowserImageFormatSupport(mimeType);\n    default:\n      return true;\n  }\n}\n\nconst TEST_IMAGE = {\n  'image/avif':\n    'data:image/avif;base64,AAAAIGZ0eXBhdmlmAAAAAGF2aWZtaWYxbWlhZk1BMUIAAADybWV0YQAAAAAAAAAoaGRscgAAAAAAAAAAcGljdAAAAAAAAAAAAAAAAGxpYmF2aWYAAAAADnBpdG0AAAAAAAEAAAAeaWxvYwAAAABEAAABAAEAAAABAAABGgAAAB0AAAAoaWluZgAAAAAAAQAAABppbmZlAgAAAAABAABhdjAxQ29sb3IAAAAAamlwcnAAAABLaXBjbwAAABRpc3BlAAAAAAAAAAIAAAACAAAAEHBpeGkAAAAAAwgICAAAAAxhdjFDgQ0MAAAAABNjb2xybmNseAACAAIAAYAAAAAXaXBtYQAAAAAAAAABAAEEAQKDBAAAACVtZGF0EgAKCBgANogQEAwgMg8f8D///8WfhwB8+ErK42A=',\n  // Lossy test image. Support for lossy images doesn't guarantee support for all WebP images.\n  'image/webp': 'data:image/webp;base64,UklGRiIAAABXRUJQVlA4IBYAAAAwAQCdASoBAAEADsD+JaQAA3AAAAAA'\n};\n\n/** Checks WebP and AVIF support asynchronously */\nasync function checkBrowserImageFormatSupportAsync(mimeType: string): Promise<boolean> {\n  const dataURL = TEST_IMAGE[mimeType];\n  return dataURL ? await testBrowserImageFormatSupportAsync(dataURL) : true;\n}\n\n/**\n * Checks browser synchronously\n * Checks if toDataURL supports the mimeType.\n * @note Imperfect testOn Chrome this is true for WebP but not for AVIF\n */\nfunction testBrowserImageFormatSupport(mimeType: string): boolean {\n  try {\n    const element = document.createElement('canvas');\n    const dataURL = element.toDataURL(mimeType);\n    return dataURL.indexOf(`data:${mimeType}`) === 0;\n  } catch {\n    // Probably Safari...\n    return false;\n  }\n}\n\n// Check WebPSupport asynchronously\nasync function testBrowserImageFormatSupportAsync(testImageDataURL: string): Promise<boolean> {\n  return new Promise((resolve) => {\n    const image = new Image();\n    image.src = testImageDataURL;\n    image.onload = () => resolve(image.height > 0);\n    image.onerror = () => resolve(false);\n  });\n}\n"],"mappings":"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"}